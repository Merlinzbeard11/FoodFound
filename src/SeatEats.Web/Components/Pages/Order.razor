@page "/order"
@page "/order/{Section}/{Row}/{Seat:int}"
@using SeatEats.Application.DTOs
@using SeatEats.Application.Services
@using SeatEats.Domain.Enums
@inject MenuService MenuService
@inject OrderService OrderService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Order Food - SeatEats</PageTitle>

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5 fw-bold text-danger">
                <span class="me-2">üçî</span>SeatEats
            </h1>
            <p class="lead text-muted">McDonald's delivered to your seat</p>
        </div>
    </div>

    @if (_orderPlaced)
    {
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-body text-center py-5">
                        <div class="display-1 text-success mb-3">‚úì</div>
                        <h2 class="card-title">Order Confirmed!</h2>
                        <p class="lead">Your order is being prepared</p>
                        <div class="alert alert-info mt-3">
                            <strong>Order #@_confirmedOrderId?.ToString()[..8]</strong><br/>
                            <small>Estimated delivery: ~15 minutes</small>
                        </div>
                        <a href="/track/@_confirmedOrderId" class="btn btn-primary btn-lg mt-3">
                            Track Your Order
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Seat Selection -->
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üìç Your Seat</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Section</label>
                            <input type="text" class="form-control form-control-lg" @bind="_section" placeholder="e.g., 101" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Row</label>
                            <input type="text" class="form-control form-control-lg" @bind="_row" placeholder="e.g., A" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Seat Number</label>
                            <input type="number" class="form-control form-control-lg" @bind="_seatNumber" min="1" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu -->
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">üçü Menu</h5>
                    </div>
                    <div class="card-body">
                        @if (_menuItems == null)
                        {
                            <div class="text-center py-4">
                                <div class="spinner-border text-danger" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        }
                        else
                        {
                            @foreach (var category in _menuItems.GroupBy(m => m.Category))
                            {
                                <h6 class="text-muted border-bottom pb-2 mt-3">@category.Key</h6>
                                <div class="row">
                                    @foreach (var item in category)
                                    {
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1">@item.Name</h6>
                                                        <small class="text-success fw-bold">$@item.Price.ToString("F2")</small>
                                                    </div>
                                                    <div class="btn-group">
                                                        @if (_cart.ContainsKey(item.Id))
                                                        {
                                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveFromCart(item.Id)">-</button>
                                                            <span class="btn btn-light btn-sm disabled">@_cart[item.Id]</span>
                                                            <button class="btn btn-outline-success btn-sm" @onclick="() => AddToCart(item)">+</button>
                                                        }
                                                        else
                                                        {
                                                            <button class="btn btn-success btn-sm" @onclick="() => AddToCart(item)">Add</button>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Summary -->
        @if (_cart.Any())
        {
            <div class="row">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning">
                            <h5 class="mb-0">üõí Your Order</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    @foreach (var item in _cart)
                                    {
                                        var menuItem = _menuItems?.FirstOrDefault(m => m.Id == item.Key);
                                        if (menuItem != null)
                                        {
                                            <span class="badge bg-secondary me-2 mb-2 p-2">
                                                @item.Value x @menuItem.Name ($@((menuItem.Price * item.Value).ToString("F2")))
                                            </span>
                                        }
                                    }
                                </div>
                                <div class="col-md-4 text-end">
                                    <h4 class="mb-0">Total: $@CalculateTotal().ToString("F2")</h4>
                                </div>
                            </div>
                            
                            @if (!string.IsNullOrEmpty(_error))
                            {
                                <div class="alert alert-danger mt-3">@_error</div>
                            }
                            
                            <div class="mt-3 text-end">
                                <button class="btn btn-lg btn-success" @onclick="PlaceOrder" disabled="@_isSubmitting">
                                    @if (_isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    Place Order üöÄ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public string? Section { get; set; }
    [Parameter] public string? Row { get; set; }
    [Parameter] public int? Seat { get; set; }

    private string _section = "";
    private string _row = "";
    private int _seatNumber = 1;
    private IReadOnlyList<MenuItemResponse>? _menuItems;
    private Dictionary<Guid, int> _cart = new();
    private bool _isSubmitting;
    private bool _orderPlaced;
    private Guid? _confirmedOrderId;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Section)) _section = Section;
        if (!string.IsNullOrEmpty(Row)) _row = Row;
        if (Seat.HasValue) _seatNumber = Seat.Value;

        var result = await MenuService.GetAvailableMenuAsync();
        if (result.IsSuccess)
        {
            _menuItems = result.Value;
        }
    }

    private void AddToCart(MenuItemResponse item)
    {
        if (_cart.ContainsKey(item.Id))
            _cart[item.Id]++;
        else
            _cart[item.Id] = 1;
    }

    private void RemoveFromCart(Guid itemId)
    {
        if (_cart.ContainsKey(itemId))
        {
            _cart[itemId]--;
            if (_cart[itemId] <= 0)
                _cart.Remove(itemId);
        }
    }

    private decimal CalculateTotal()
    {
        return _cart.Sum(c => 
        {
            var item = _menuItems?.FirstOrDefault(m => m.Id == c.Key);
            return item?.Price * c.Value ?? 0;
        });
    }

    private async Task PlaceOrder()
    {
        _error = null;
        _isSubmitting = true;

        var request = new CreateOrderRequest(
            _section,
            _row,
            _seatNumber,
            _cart.Select(c => new OrderItemRequest(c.Key, c.Value)).ToList()
        );

        var result = await OrderService.CreateOrderAsync(request);

        if (result.IsSuccess)
        {
            _orderPlaced = true;
            _confirmedOrderId = result.Value!.Id;
        }
        else
        {
            _error = result.Error;
        }

        _isSubmitting = false;
    }
}
