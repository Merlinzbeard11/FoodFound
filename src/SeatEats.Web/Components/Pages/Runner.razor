@page "/runner"
@using Microsoft.AspNetCore.SignalR.Client
@using SeatEats.Application.DTOs
@using SeatEats.Application.Services
@using SeatEats.Domain.Enums
@inject OrderService OrderService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>Runner - FoodFound</PageTitle>

<div class="runner-page">
    <!-- Top Bar -->
    <header class="runner-topbar">
        <div class="runner-topbar-inner">
            <div class="runner-topbar-left">
                <h1 class="runner-title">Runner</h1>
                <span class="runner-subtitle">Auto-updating every 5s</span>
            </div>
            <div class="runner-topbar-right">
                <span class="runner-id-badge">@_runnerId.ToString()[..8]</span>
                <span class="runner-live @(_hubConnection?.State == HubConnectionState.Connected ? "runner-live-on" : "runner-live-off")">
                    @(_hubConnection?.State == HubConnectionState.Connected ? "LIVE" : "...")
                </span>
                <button type="button" class="runner-refresh-btn" @onclick="LoadOrders" aria-label="Refresh">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Active Delivery -->
    @if (_myActiveOrder != null)
    {
        <div class="runner-active">
            <div class="runner-active-inner">
                <span class="runner-active-label">DELIVERING NOW</span>
                <h2 class="runner-active-seat">@FormatSeat(_myActiveOrder.SeatLocation)</h2>
                <p class="runner-active-items">@FormatItems(_myActiveOrder.Items)</p>
                <span class="runner-active-total">$@_myActiveOrder.TotalAmount.ToString("F2")</span>
                <button type="button" class="runner-deliver-btn" @onclick="MarkDelivered">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                    Mark Delivered
                </button>
                <span class="runner-active-hint">Head to @_myActiveOrder.SeatLocation &rarr;</span>
            </div>
        </div>
    }

    <!-- Ready for Pickup -->
    <div class="runner-ready">
        <div class="runner-ready-header">
            <h2 class="runner-ready-title">Ready for Pickup</h2>
            <span class="runner-ready-count">@_readyOrders.Count</span>
        </div>

        @if (_readyOrders.Any())
        {
            <div class="runner-grid">
                @foreach (var order in _readyOrders)
                {
                    <div class="runner-card">
                        <div class="runner-card-top"></div>
                        <div class="runner-card-body">
                            <span class="runner-card-seat">@FormatSeat(order.SeatLocation)</span>
                            <span class="runner-card-time">Ready @GetTimeAgo(order.CreatedAt)</span>
                            <div class="runner-card-divider"></div>
                            <p class="runner-card-items">@FormatItems(order.Items)</p>
                            <span class="runner-card-total">$@order.TotalAmount.ToString("F2")</span>
                            <button type="button"
                                    class="runner-claim-btn @(_myActiveOrder != null ? "runner-claim-disabled" : "")"
                                    disabled="@(_myActiveOrder != null)"
                                    @onclick="() => ClaimOrder(order.Id)">
                                @(_myActiveOrder != null ? "Currently Delivering" : "Claim Order")
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="runner-empty">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>
                <p>No orders ready â€” they'll appear here when fans get hungry!</p>
            </div>
        }
    </div>
</div>

@code {
    private List<OrderResponse> _readyOrders = new();
    private OrderResponse? _myActiveOrder;
    private Guid _runnerId = Guid.NewGuid();
    private HubConnection? _hubConnection;
    private bool _initialized;

    protected override async Task OnInitializedAsync() => await LoadOrders();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized) { _initialized = true; await SetupSignalR(); StateHasChanged(); }
    }

    private async Task SetupSignalR()
    {
        _hubConnection = new HubConnectionBuilder().WithUrl(Navigation.ToAbsoluteUri("/orderhub")).WithAutomaticReconnect().Build();
        _hubConnection.On<Guid, string>("OrderReady", async (_, _) => { await LoadOrders(); await InvokeAsync(StateHasChanged); });
        _hubConnection.On<Guid>("OrderClaimed", async (_) => { await LoadOrders(); await InvokeAsync(StateHasChanged); });
        _hubConnection.On<Guid, OrderStatus>("OrderStatusChanged", async (_, _) => { await LoadOrders(); await InvokeAsync(StateHasChanged); });
        await _hubConnection.StartAsync();
        await _hubConnection.InvokeAsync("JoinRunnerGroup");
    }

    private async Task LoadOrders()
    {
        var ready = await OrderService.GetOrdersByStatusAsync(OrderStatus.Ready);
        if (ready.IsSuccess) _readyOrders = ready.Value!.ToList();
        var enRoute = await OrderService.GetOrdersByStatusAsync(OrderStatus.EnRoute);
        if (enRoute.IsSuccess) _myActiveOrder = enRoute.Value!.FirstOrDefault();
    }

    private async Task ClaimOrder(Guid id)
    {
        var result = await OrderService.UpdateOrderStatusAsync(id, OrderStatus.EnRoute, _runnerId);
        if (result.IsSuccess) _myActiveOrder = result.Value;
        await LoadOrders();
    }

    private async Task MarkDelivered()
    {
        if (_myActiveOrder != null) { await OrderService.UpdateOrderStatusAsync(_myActiveOrder.Id, OrderStatus.Delivered); _myActiveOrder = null; }
        await LoadOrders();
    }

    private static string FormatSeat(string seatLocation) =>
        seatLocation.Replace("Section ", "Sec ").Replace(", ", " \u00b7 ");

    private static string FormatItems(List<OrderItemResponse> items) =>
        string.Join(", ", items.Select(i => $"{i.Quantity}x {i.Name}"));

    private static string GetTimeAgo(DateTime createdAt)
    {
        var diff = DateTime.UtcNow - createdAt.ToUniversalTime();
        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 2) return "1 min ago";
        if (diff.TotalHours < 1) return $"{(int)diff.TotalMinutes} min ago";
        return $"{(int)diff.TotalHours}h ago";
    }

    public async ValueTask DisposeAsync() { if (_hubConnection != null) await _hubConnection.DisposeAsync(); }
}
