@page "/track/{OrderId:guid}"
@using Microsoft.AspNetCore.SignalR.Client
@using SeatEats.Application.DTOs
@using SeatEats.Application.Services
@using SeatEats.Domain.Enums
@inject OrderService OrderService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>Track Order - FoodFound</PageTitle>

<div class="track-page">
    <!-- Top Bar -->
    <header class="track-topbar">
        <div class="track-topbar-inner">
            <a href="/" class="track-back">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                <span>FoodFound</span>
            </a>
            <span class="track-live @(_hubConnection?.State == HubConnectionState.Connected ? "track-live-on" : "track-live-off")">
                @(_hubConnection?.State == HubConnectionState.Connected ? "LIVE" : "...")
            </span>
        </div>
    </header>

    <div class="track-content">
        @if (_order == null)
        {
            <div class="track-loading">
                <div class="order-loading-dot"></div>
                <div class="order-loading-dot"></div>
                <div class="order-loading-dot"></div>
            </div>
        }
        else
        {
            <div class="track-card">
                <!-- Seat -->
                <div class="track-seat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"/><circle cx="12" cy="10" r="3"/></svg>
                    <span>@_order.SeatLocation</span>
                </div>

                <!-- Progress Steps -->
                <div class="track-steps">
                    <div class="track-steps-line"></div>
                    <div class="track-steps-fill" style="width: @GetProgressWidth()"></div>
                    @foreach (var (status, icon, label) in _steps)
                    {
                        var isActive = _order.Status >= status;
                        var isCurrent = _order.Status == status;
                        <div class="track-step @(isActive ? "track-step-active" : "") @(isCurrent ? "track-step-current" : "")">
                            <div class="track-step-circle">@icon</div>
                            <span class="track-step-label">@label</span>
                        </div>
                    }
                </div>

                <!-- Status Message -->
                <div class="track-status-msg @(_order.Status == OrderStatus.Delivered ? "track-status-done" : "")">
                    @GetStatusMessage()
                </div>

                <!-- Order Details -->
                <div class="track-details">
                    <h3 class="track-details-title">Order Details</h3>
                    @foreach (var item in _order.Items)
                    {
                        <div class="track-detail-row">
                            <span>@item.Quantity x @item.Name</span>
                            <span>$@item.TotalPrice.ToString("F2")</span>
                        </div>
                    }
                    <div class="track-detail-total">
                        <span>Total</span>
                        <span>$@_order.TotalAmount.ToString("F2")</span>
                    </div>
                </div>

                @if (_order.Status == OrderStatus.Delivered)
                {
                    <a href="/order" class="track-reorder">Order Again</a>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public Guid OrderId { get; set; }
    private OrderResponse? _order;
    private HubConnection? _hubConnection;
    private bool _initialized;

    private static readonly (OrderStatus, string, string)[] _steps = new[]
    {
        (OrderStatus.Received, "1", "Received"),
        (OrderStatus.Preparing, "2", "Cooking"),
        (OrderStatus.Ready, "3", "Ready"),
        (OrderStatus.EnRoute, "4", "On Way"),
        (OrderStatus.Delivered, "5", "Done!")
    };

    protected override async Task OnInitializedAsync() => await LoadOrder();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized) { _initialized = true; await SetupSignalR(); StateHasChanged(); }
    }

    private async Task SetupSignalR()
    {
        _hubConnection = new HubConnectionBuilder().WithUrl(Navigation.ToAbsoluteUri("/orderhub")).WithAutomaticReconnect().Build();
        _hubConnection.On<Guid, OrderStatus>("OrderStatusChanged", async (id, _) => { if (id == OrderId) { await LoadOrder(); await InvokeAsync(StateHasChanged); } });
        await _hubConnection.StartAsync();
        await _hubConnection.InvokeAsync("JoinOrderGroup", OrderId.ToString());
    }

    private async Task LoadOrder() { var result = await OrderService.GetOrderAsync(OrderId); if (result.IsSuccess) _order = result.Value; }

    private string GetStatusMessage() => _order?.Status switch
    {
        OrderStatus.Received => "Order received! Kitchen has been notified.",
        OrderStatus.Preparing => "Your food is being prepared fresh...",
        OrderStatus.Ready => "Ready! A runner is picking it up now.",
        OrderStatus.EnRoute => "On the way to your seat!",
        OrderStatus.Delivered => "Delivered! Enjoy your meal!",
        _ => "Unknown"
    };

    private string GetProgressWidth() => _order?.Status switch
    {
        OrderStatus.Received => "0%",
        OrderStatus.Preparing => "25%",
        OrderStatus.Ready => "50%",
        OrderStatus.EnRoute => "75%",
        OrderStatus.Delivered => "100%",
        _ => "0%"
    };

    public async ValueTask DisposeAsync() { if (_hubConnection != null) await _hubConnection.DisposeAsync(); }
}
