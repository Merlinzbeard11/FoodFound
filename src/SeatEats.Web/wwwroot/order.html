<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order - FoodFound</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .brand-color { color: #ff6b35; }
        .brand-bg { background-color: #ff6b35; }
        /* Mobile touch fixes */
        [data-action], button {
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        /* Ensure minimum touch target */
        .btn { min-height: 44px; min-width: 44px; }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5 fw-bold brand-color">FoodFound</h1>
            <p class="lead text-muted">Order delivered to your seat</p>
        </div>
    </div>

    <div id="order-form">
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm border-0" style="border-top: 4px solid #ff6b35 !important;">
                    <div class="card-header text-white brand-bg"><h5 class="mb-0">Your Seat</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Section</label>
                            <input type="text" class="form-control form-control-lg" id="section" value="101" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Row</label>
                            <input type="text" class="form-control form-control-lg" id="row" value="A" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Seat</label>
                            <input type="number" class="form-control form-control-lg" id="seat" value="1" min="1" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header text-white bg-danger"><h5 class="mb-0">Menu</h5></div>
                    <div class="card-body" id="menu-container">
                        <div class="text-center py-4"><div class="spinner-border brand-color"></div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="cart-section" style="display:none;">
            <div class="col-12">
                <div class="card shadow border-0" style="border-top: 4px solid #ff6b35 !important;">
                    <div class="card-header" style="background-color: #fff3e6;"><h5 class="mb-0">Your Order</h5></div>
                    <div class="card-body">
                        <div id="cart-items"></div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <h4 class="mb-0 brand-color">Total: $<span id="cart-total">0.00</span></h4>
                            <button class="btn btn-lg btn-success" id="place-order-btn">Place Order</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmation" style="display:none;" class="row justify-content-center">
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-body text-center py-5">
                    <div class="display-1 text-success mb-3">âœ“</div>
                    <h2>Order Confirmed!</h2>
                    <p class="lead">Your food is being prepared</p>
                    <div class="alert mt-3" style="background-color: #fff3e6;">
                        <strong>Order #<span id="order-id"></span></strong><br/>
                        <small>Est. delivery: ~15 minutes</small>
                    </div>
                    <a id="track-link" href="#" class="btn btn-lg brand-bg text-white mt-3">Track Order</a>
                    <button class="btn btn-lg btn-outline-secondary mt-3 ms-2" onclick="newOrder()">New Order</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let menu = [];
let cart = {};

async function loadMenu() {
    try {
        const res = await fetch('/api/orders/menu');
        if (!res.ok) throw new Error('Failed to load menu');
        menu = await res.json();
        renderMenu();
    } catch (e) {
        document.getElementById('menu-container').innerHTML = '<div class="alert alert-danger">Failed to load menu. <button class="btn btn-sm btn-primary" onclick="loadMenu()">Retry</button></div>';
    }
}

function renderMenu() {
    const container = document.getElementById('menu-container');
    const categories = [...new Set(menu.map(m => m.category))];
    let html = '';
    categories.forEach(cat => {
        html += '<h6 class="text-muted border-bottom pb-2 mt-3">' + cat + '</h6><div class="row">';
        menu.filter(m => m.category === cat).forEach(item => {
            const qty = cart[item.id] || 0;
            html += '<div class="col-md-6 mb-3"><div class="card h-100 border"><div class="card-body d-flex justify-content-between align-items-center p-3">';
            html += '<div><h6 class="mb-1">' + item.name + '</h6><small class="fw-bold brand-color">$' + item.price.toFixed(2) + '</small></div>';
            html += '<div class="btn-group">';
            if (qty > 0) {
                html += '<button class="btn btn-outline-danger btn-sm" data-action="remove" data-id="' + item.id + '">-</button>';
                html += '<span class="btn btn-light btn-sm disabled">' + qty + '</span>';
                html += '<button class="btn btn-outline-success btn-sm" data-action="add" data-id="' + item.id + '">+</button>';
            } else {
                html += '<button class="btn btn-sm btn-success" data-action="add" data-id="' + item.id + '">Add</button>';
            }
            html += '</div></div></div></div>';
        });
        html += '</div>';
    });
    container.innerHTML = html;
    updateCart();
}

function handleAction(e) {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    e.preventDefault();
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    if (action === 'add') {
        cart[id] = (cart[id] || 0) + 1;
        renderMenu();
    } else if (action === 'remove') {
        if (cart[id]) { cart[id]--; if (cart[id] <= 0) delete cart[id]; }
        renderMenu();
    }
}
document.addEventListener('click', handleAction);
document.addEventListener('touchend', handleAction);

function updateCart() {
    const cartSection = document.getElementById('cart-section');
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    const ids = Object.keys(cart);
    if (ids.length === 0) { cartSection.style.display = 'none'; return; }
    cartSection.style.display = 'block';
    let html = '', total = 0;
    ids.forEach(id => {
        const item = menu.find(m => m.id === id);
        if (item) {
            total += item.price * cart[id];
            html += '<span class="badge me-2 mb-2 p-2 brand-bg text-white">' + cart[id] + ' x ' + item.name + '</span>';
        }
    });
    cartItems.innerHTML = html;
    cartTotal.textContent = total.toFixed(2);
}

document.getElementById('place-order-btn').addEventListener('click', async function() {
    const items = Object.entries(cart).map(([id, qty]) => ({ menuItemId: id, quantity: qty }));
    if (items.length === 0) { alert('Add items to cart first'); return; }
    const body = {
        section: document.getElementById('section').value,
        row: document.getElementById('row').value,
        seatNumber: parseInt(document.getElementById('seat').value),
        items: items
    };
    try {
        const res = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if (res.ok) {
            const order = await res.json();
            document.getElementById('order-form').style.display = 'none';
            document.getElementById('confirmation').style.display = 'block';
            document.getElementById('order-id').textContent = order.id.substring(0, 8);
            document.getElementById('track-link').href = '/track/' + order.id;
            cart = {};
        } else {
            alert('Error placing order');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
});

function newOrder() {
    cart = {};
    document.getElementById('order-form').style.display = 'block';
    document.getElementById('confirmation').style.display = 'none';
    renderMenu();
}

loadMenu();
</script>
</body>
</html>
