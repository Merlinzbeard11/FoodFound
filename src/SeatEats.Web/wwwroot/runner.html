<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Runner - FoodFound</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        button, [data-action] { cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1); }
    </style>
</head>
<body>
<div class="container py-3">
    <div class="row mb-3">
        <div class="col"><h2><span style="color: #ff6b35;">Runner</span> Dashboard</h2></div>
        <div class="col-auto"><button class="btn btn-outline-secondary" data-action="refresh">Refresh</button></div>
    </div>
    <div id="active-delivery" style="display:none;" class="row mb-4">
        <div class="col-12">
            <div class="card shadow" style="border-top: 4px solid #ff6b35;">
                <div class="card-header text-white" style="background-color: #ff6b35;"><h5 class="mb-0">Active Delivery</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h3 style="color: #ff6b35;" id="active-seat"></h3>
                            <ul class="list-group list-group-flush" id="active-items"></ul>
                        </div>
                        <div class="col-md-6 d-flex flex-column justify-content-center align-items-center">
                            <div class="display-4 mb-3">Target</div>
                            <button class="btn btn-success btn-lg w-100" data-action="deliver" id="deliver-btn">Mark Delivered</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="border-top: 4px solid #28a745;">
                <div class="card-header bg-success text-white d-flex justify-content-between">
                    <span>Ready for Pickup</span><span class="badge bg-white text-success" id="ready-count">0</span>
                </div>
                <div class="card-body" id="ready-orders"></div>
            </div>
        </div>
    </div>
</div>
<script>
// OrderStatus enum: Received=1, Preparing=2, Ready=3, EnRoute=4, Delivered=5
let activeOrder = null;
const runnerId = localStorage.getItem('runnerId') || (function() {
    const id = crypto.randomUUID();
    localStorage.setItem('runnerId', id);
    return id;
})();

async function loadOrders() {
    try {
        const [ready, enRoute] = await Promise.all([
            fetch('/api/orders/status/3').then(r => r.json()),
            fetch('/api/orders/status/4').then(r => r.json())
        ]);
        activeOrder = enRoute.length > 0 ? enRoute[0] : null;
        renderActive();
        renderReady(ready);
        document.getElementById('ready-count').textContent = ready.length;
    } catch (e) {
        console.error('Error loading orders:', e);
    }
}

function renderActive() {
    const container = document.getElementById('active-delivery');
    if (!activeOrder) { container.style.display = 'none'; return; }
    container.style.display = 'block';
    document.getElementById('active-seat').textContent = activeOrder.seatLocation;
    document.getElementById('deliver-btn').dataset.id = activeOrder.id;
    let html = '';
    activeOrder.items.forEach(i => {
        html += '<li class="list-group-item d-flex justify-content-between"><span>' + i.quantity + ' x ' + i.name + '</span><span class="badge bg-secondary">$' + i.totalPrice.toFixed(2) + '</span></li>';
    });
    document.getElementById('active-items').innerHTML = html;
}

function renderReady(orders) {
    const container = document.getElementById('ready-orders');
    if (orders.length === 0) {
        container.innerHTML = '<div class="text-center py-5"><div class="display-1 mb-3">Coffee</div><p class="text-muted">No orders ready. Take a breather!</p></div>';
        return;
    }
    let html = '<div class="row">';
    orders.forEach(o => {
        html += '<div class="col-md-4 mb-3"><div class="card h-100 border-success"><div class="card-body">';
        html += '<h5 class="card-title text-success">' + o.seatLocation + '</h5>';
        html += '<p class="text-muted mb-2"><small>' + new Date(o.createdAt).toLocaleTimeString() + '</small></p>';
        html += '<ul class="list-unstyled">';
        o.items.forEach(i => { html += '<li><small>' + i.quantity + ' x ' + i.name + '</small></li>'; });
        html += '</ul>';
        html += '<div class="d-flex justify-content-between align-items-center mt-3">';
        html += '<span class="fw-bold" style="color: #ff6b35;">$' + o.totalAmount.toFixed(2) + '</span>';
        html += '<button class="btn" style="background-color: #ff6b35; color: white;" data-action="claim" data-id="' + o.id + '"' + (activeOrder ? ' disabled' : '') + '>Claim</button>';
        html += '</div></div></div></div>';
    });
    html += '</div>';
    container.innerHTML = html;
}

document.addEventListener('click', async function(e) {
    const action = e.target.dataset.action;
    if (action === 'refresh') {
        loadOrders();
    } else if (action === 'claim') {
        const id = e.target.dataset.id;
        e.target.disabled = true;
        e.target.textContent = 'Claiming...';
        try {
            await fetch('/api/orders/' + id + '/status', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 4, runnerId: runnerId })
            });
            loadOrders();
        } catch (err) {
            alert('Error claiming order');
            e.target.disabled = false;
        }
    } else if (action === 'deliver') {
        const id = e.target.dataset.id;
        e.target.disabled = true;
        e.target.textContent = 'Delivering...';
        try {
            await fetch('/api/orders/' + id + '/status', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 5 })
            });
            activeOrder = null;
            loadOrders();
        } catch (err) {
            alert('Error marking delivered');
            e.target.disabled = false;
        }
    }
});

loadOrders();
setInterval(loadOrders, 5000);
</script>
</body>
</html>
