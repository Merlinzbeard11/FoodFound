<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kitchen - FoodFound</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        button, [data-action] {
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .btn { min-height: 44px; }
    </style>
</head>
<body>
<div class="container-fluid py-3">
    <div class="row mb-3">
        <div class="col"><h2><span style="color: #ff6b35;">Kitchen</span> Dashboard</h2></div>
        <div class="col-auto"><button class="btn btn-outline-secondary" data-action="refresh">Refresh</button></div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <div class="card h-100 shadow-sm" style="border-top: 4px solid #dc3545;">
                <div class="card-header bg-danger text-white d-flex justify-content-between">
                    <span>New Orders</span><span class="badge bg-white text-danger" id="received-count">0</span>
                </div>
                <div class="card-body overflow-auto" style="max-height: 70vh;" id="received-orders"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 shadow-sm" style="border-top: 4px solid #ffc107;">
                <div class="card-header bg-warning d-flex justify-content-between">
                    <span>Preparing</span><span class="badge bg-dark" id="preparing-count">0</span>
                </div>
                <div class="card-body overflow-auto" style="max-height: 70vh;" id="preparing-orders"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 shadow-sm" style="border-top: 4px solid #28a745;">
                <div class="card-header bg-success text-white d-flex justify-content-between">
                    <span>Ready</span><span class="badge bg-white text-success" id="ready-count">0</span>
                </div>
                <div class="card-body overflow-auto" style="max-height: 70vh;" id="ready-orders"></div>
            </div>
        </div>
    </div>
</div>
<script>
// OrderStatus enum: Received=1, Preparing=2, Ready=3, EnRoute=4, Delivered=5
async function loadOrders() {
    try {
        const [r1, r2, r3] = await Promise.all([
            fetch('/api/orders/status/1').then(r => r.json()),
            fetch('/api/orders/status/2').then(r => r.json()),
            fetch('/api/orders/status/3').then(r => r.json())
        ]);
        renderOrders('received', r1, 'danger', 'Start Preparing', 2);
        renderOrders('preparing', r2, 'warning', 'Mark Ready', 3);
        renderOrders('ready', r3, 'success', null, null);
        document.getElementById('received-count').textContent = r1.length;
        document.getElementById('preparing-count').textContent = r2.length;
        document.getElementById('ready-count').textContent = r3.length;
    } catch (e) {
        console.error('Error loading orders:', e);
    }
}

function renderOrders(type, orders, color, btnText, nextStatus) {
    const container = document.getElementById(type + '-orders');
    if (orders.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-4">No orders</p>';
        return;
    }
    let html = '';
    orders.forEach(o => {
        html += '<div class="card mb-2 border-' + color + '"><div class="card-body p-3">';
        html += '<div class="d-flex justify-content-between mb-2"><strong class="text-' + color + '">' + o.seatLocation + '</strong>';
        html += '<small class="text-muted">' + new Date(o.createdAt).toLocaleTimeString() + '</small></div>';
        html += '<ul class="list-unstyled mb-2">';
        o.items.forEach(i => { html += '<li><small>' + i.quantity + ' x ' + i.name + '</small></li>'; });
        html += '</ul>';
        if (btnText) {
            html += '<button class="btn btn-' + (nextStatus === 2 ? 'warning' : 'success') + ' btn-sm w-100" data-action="update-status" data-id="' + o.id + '" data-status="' + nextStatus + '">' + btnText + '</button>';
        } else {
            html += '<div class="text-center"><span class="badge" style="background-color: #ff6b35;">Waiting for runner</span></div>';
        }
        html += '</div></div>';
    });
    container.innerHTML = html;
}

async function handleAction(e) {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    e.preventDefault();
    const action = btn.dataset.action;
    if (action === 'refresh') {
        loadOrders();
    } else if (action === 'update-status') {
        const id = btn.dataset.id;
        const status = parseInt(btn.dataset.status);
        btn.disabled = true;
        btn.textContent = 'Updating...';
        try {
            await fetch('/api/orders/' + id + '/status', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            loadOrders();
        } catch (err) {
            alert('Error updating order');
            btn.disabled = false;
        }
    }
}
document.addEventListener('click', handleAction);
document.addEventListener('touchend', handleAction);

loadOrders();
setInterval(loadOrders, 5000);
</script>
</body>
</html>
