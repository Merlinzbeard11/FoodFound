@page "/order"
@page "/order/{Section}/{Row}/{Seat:int}"
@using SeatEats.Application.DTOs
@using SeatEats.Application.Services
@using SeatEats.Domain.Enums
@inject MenuService MenuService
@inject OrderService OrderService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Order - FoodFound</PageTitle>

<div class="order-page">
    <!-- Top Bar -->
    <header class="order-topbar">
        <div class="order-topbar-inner">
            <a href="/" class="order-back">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                <span class="order-back-text">FoodFound</span>
            </a>
            @if (_cart.Any() && !_orderPlaced)
            {
                <button type="button" class="order-cart-icon" @onclick="ScrollToCart">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                    <span class="order-cart-badge">@_cart.Values.Sum()</span>
                </button>
            }
        </div>
    </header>

    @if (_orderPlaced)
    {
        <!-- Confirmation -->
        <div class="order-confirm">
            <div class="order-confirm-card">
                <div class="order-confirm-check">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <h2 class="order-confirm-title">Order Confirmed!</h2>
                <p class="order-confirm-id">Order #@_confirmedOrderId?.ToString()[..8]</p>
                <div class="order-confirm-eta">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    Estimated delivery: ~15 minutes
                </div>
                <a href="/track/@_confirmedOrderId" class="order-confirm-track">Track Your Order</a>
                <span class="order-confirm-or">or</span>
                <button type="button" class="order-confirm-new" @onclick="StartNewOrder">New Order</button>
            </div>
        </div>
    }
    else
    {
        <!-- Seat Banner -->
        <div class="order-seat-banner">
            <span class="order-seat-label">Delivering to:</span>
            <input type="text" class="order-seat-input" @bind="_section" placeholder="Sec" />
            <input type="text" class="order-seat-input" @bind="_row" placeholder="Row" />
            <input type="number" class="order-seat-input order-seat-input-num" @bind="_seatNumber" min="1" placeholder="Seat" />
        </div>

        <!-- Category Tabs -->
        @if (_menuItems != null)
        {
            <div class="order-cat-tabs">
                @foreach (var cat in _menuItems.Select(m => m.Category).Distinct())
                {
                    <button type="button"
                            class="order-cat-pill @(_activeCategory == cat ? "order-cat-pill-active" : "")"
                            @onclick="() => _activeCategory = cat">
                        @cat
                    </button>
                }
            </div>
        }

        <!-- Menu -->
        <div class="order-menu">
            @if (_menuItems == null)
            {
                <div class="order-loading">
                    <div class="order-loading-dot"></div>
                    <div class="order-loading-dot"></div>
                    <div class="order-loading-dot"></div>
                </div>
            }
            else
            {
                @foreach (var category in _menuItems.GroupBy(m => m.Category))
                {
                    <div class="order-menu-group" style="@(_activeCategory != null && _activeCategory != category.Key ? "display:none;" : "")">
                        <div class="order-menu-cat-header">
                            <span class="order-menu-cat-accent"></span>
                            <h3 class="order-menu-cat-title">@category.Key</h3>
                        </div>
                        @foreach (var item in category)
                        {
                            <div class="order-menu-item">
                                <div class="order-menu-item-img">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 11h.01"/><path d="M11 15h.01"/><path d="M16 16h.01"/><path d="m2 16 20 6-6-20A20 20 0 0 0 2 16"/></svg>
                                </div>
                                <div class="order-menu-item-info">
                                    <span class="order-menu-item-name">@item.Name</span>
                                    <span class="order-menu-item-desc">@item.Description</span>
                                    <span class="order-menu-item-price">$@item.Price.ToString("F2")</span>
                                </div>
                                <div class="order-menu-item-actions">
                                    @if (_cart.ContainsKey(item.Id))
                                    {
                                        <button type="button" class="order-qty-btn order-qty-minus" @onclick="() => RemoveFromCart(item.Id)">-</button>
                                        <span class="order-qty-count">@_cart[item.Id]</span>
                                        <button type="button" class="order-qty-btn order-qty-plus" @onclick="() => AddToCart(item)">+</button>
                                    }
                                    else
                                    {
                                        <button type="button" class="order-add-btn" @onclick="() => AddToCart(item)">Add</button>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- Bottom Cart Bar -->
        @if (_cart.Any())
        {
            <div class="order-cart-bar" id="cart-section">
                <span class="order-cart-summary">@_cart.Values.Sum() items</span>
                <span class="order-cart-total">$@CalculateTotal().ToString("F2")</span>
                <button type="button" class="order-place-btn" @onclick="PlaceOrder" disabled="@_isSubmitting">
                    @if (_isSubmitting) { <span class="order-spinner"></span> }
                    Place Order
                </button>
            </div>
        }

        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="order-error">@_error</div>
        }
    }
</div>

@code {
    [Parameter] public string? Section { get; set; }
    [Parameter] public string? Row { get; set; }
    [Parameter] public int? Seat { get; set; }

    private string _section = "";
    private string _row = "";
    private int _seatNumber = 1;
    private IReadOnlyList<MenuItemResponse>? _menuItems;
    private Dictionary<Guid, int> _cart = new();
    private bool _isSubmitting;
    private bool _orderPlaced;
    private Guid? _confirmedOrderId;
    private string? _error;
    private string? _activeCategory;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Section)) _section = Section;
        if (!string.IsNullOrEmpty(Row)) _row = Row;
        if (Seat.HasValue) _seatNumber = Seat.Value;
        var result = await MenuService.GetAvailableMenuAsync();
        if (result.IsSuccess) _menuItems = result.Value;
    }

    private void AddToCart(MenuItemResponse item)
    {
        if (_cart.ContainsKey(item.Id)) _cart[item.Id]++;
        else _cart[item.Id] = 1;
    }

    private void RemoveFromCart(Guid itemId)
    {
        if (_cart.ContainsKey(itemId))
        {
            _cart[itemId]--;
            if (_cart[itemId] <= 0) _cart.Remove(itemId);
        }
    }

    private decimal CalculateTotal() => _cart.Sum(c =>
    {
        var item = _menuItems?.FirstOrDefault(m => m.Id == c.Key);
        return item?.Price * c.Value ?? 0;
    });

    private async Task PlaceOrder()
    {
        _error = null;
        _isSubmitting = true;
        var request = new CreateOrderRequest(_section, _row, _seatNumber,
            _cart.Select(c => new OrderItemRequest(c.Key, c.Value)).ToList());
        var result = await OrderService.CreateOrderAsync(request);
        if (result.IsSuccess) { _orderPlaced = true; _confirmedOrderId = result.Value!.Id; }
        else { _error = result.Error; }
        _isSubmitting = false;
    }

    private void StartNewOrder()
    {
        _orderPlaced = false;
        _confirmedOrderId = null;
        _cart.Clear();
        _error = null;
    }

    private void ScrollToCart() { }
}
