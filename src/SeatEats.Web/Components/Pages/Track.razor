@page "/track/{OrderId:guid}"
@using Microsoft.AspNetCore.SignalR.Client
@using SeatEats.Application.DTOs
@using SeatEats.Application.Services
@using SeatEats.Domain.Enums
@inject OrderService OrderService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>Track Order - SeatEats</PageTitle>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            @if (_order == null)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">üìç Order Tracking</h4>
                        <span class="badge bg-light text-dark">
                            @(_hubConnection?.State == HubConnectionState.Connected ? "üü¢ Live" : "üî¥ Connecting...")
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <h5>Delivering to: <span class="text-primary">@_order.SeatLocation</span></h5>
                        </div>

                        <!-- Progress Steps -->
                        <div class="d-flex justify-content-between mb-4 position-relative">
                            <div class="position-absolute top-50 start-0 end-0" style="height: 4px; background: #e9ecef; z-index: 0; transform: translateY(-50%);"></div>
                            
                            @{
                                var steps = new[] { 
                                    (OrderStatus.Received, "üìù", "Received"),
                                    (OrderStatus.Preparing, "üî•", "Preparing"),
                                    (OrderStatus.Ready, "‚úÖ", "Ready"),
                                    (OrderStatus.EnRoute, "üèÉ", "On the Way"),
                                    (OrderStatus.Delivered, "üéâ", "Delivered")
                                };
                            }
                            
                            @foreach (var (status, emoji, label) in steps)
                            {
                                var isActive = _order.Status >= status;
                                var isCurrent = _order.Status == status;
                                <div class="text-center position-relative" style="z-index: 1;">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 @(isActive ? "bg-success" : "bg-secondary")" 
                                         style="width: 50px; height: 50px; @(isCurrent ? "box-shadow: 0 0 0 4px rgba(25, 135, 84, 0.3); animation: pulse 2s infinite;" : "")">
                                        <span class="fs-4">@emoji</span>
                                    </div>
                                    <small class="@(isActive ? "text-success fw-bold" : "text-muted")">@label</small>
                                </div>
                            }
                        </div>

                        <!-- Current Status -->
                        <div class="alert @GetStatusAlertClass() text-center">
                            <h5 class="mb-0">@GetStatusMessage()</h5>
                        </div>

                        <!-- Order Details -->
                        <h6 class="mt-4">Order Details</h6>
                        <ul class="list-group">
                            @foreach (var item in _order.Items)
                            {
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>@item.Quantity x @item.Name</span>
                                    <span>$@item.TotalPrice.ToString("F2")</span>
                                </li>
                            }
                            <li class="list-group-item d-flex justify-content-between fw-bold">
                                <span>Total</span>
                                <span>$@_order.TotalAmount.ToString("F2")</span>
                            </li>
                        </ul>

                        @if (_order.Status == OrderStatus.Delivered)
                        {
                            <div class="text-center mt-4">
                                <a href="/order" class="btn btn-danger btn-lg">Order Again üçî</a>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    @@keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(25, 135, 84, 0); }
        100% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0); }
    }
</style>

@code {
    [Parameter] public Guid OrderId { get; set; }
    
    private OrderResponse? _order;
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrder();
        await SetupSignalR();
    }

    private async Task SetupSignalR()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/orderhub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<Guid, OrderStatus>("OrderStatusChanged", async (orderId, newStatus) =>
        {
            if (orderId == OrderId)
            {
                await LoadOrder();
                await InvokeAsync(StateHasChanged);
            }
        });

        await _hubConnection.StartAsync();
        await _hubConnection.InvokeAsync("JoinOrderGroup", OrderId.ToString());
    }

    private async Task LoadOrder()
    {
        var result = await OrderService.GetOrderAsync(OrderId);
        if (result.IsSuccess)
        {
            _order = result.Value;
        }
    }

    private string GetStatusAlertClass() => _order?.Status switch
    {
        OrderStatus.Received => "alert-info",
        OrderStatus.Preparing => "alert-warning",
        OrderStatus.Ready => "alert-success",
        OrderStatus.EnRoute => "alert-primary",
        OrderStatus.Delivered => "alert-success",
        _ => "alert-secondary"
    };

    private string GetStatusMessage() => _order?.Status switch
    {
        OrderStatus.Received => "Your order has been received!",
        OrderStatus.Preparing => "Kitchen is preparing your food...",
        OrderStatus.Ready => "Your order is ready for pickup!",
        OrderStatus.EnRoute => "Runner is on the way to your seat!",
        OrderStatus.Delivered => "Enjoy your meal! üéâ",
        _ => "Unknown status"
    };

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
